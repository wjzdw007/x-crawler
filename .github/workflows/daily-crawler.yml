name: Daily X Crawler

on:
  # å®šæ—¶ä»»åŠ¡ - æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹è¿è¡Œ (UTC+8 = 01:00 UTC)
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤© UTC 01:00 (åŒ—äº¬æ—¶é—´ 09:00)

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tweet_count:
        description: 'è¦çˆ¬å–çš„æŽ¨æ–‡æ•°é‡'
        required: false
        default: '500'
      force_summary:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ€»ç»“ (true/false)'
        required: false
        default: 'false'

jobs:
  crawl-and-summarize:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          # ä¿ç•™å®Œæ•´æäº¤åŽ†å²ï¼Œæ”¯æŒåŽç»­æäº¤
          fetch-depth: 0

      # 2. è®¾ç½® Python çŽ¯å¢ƒ
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # ç¼“å­˜ä¾èµ–åŠ é€Ÿæž„å»º

      # 3. å®‰è£…ç³»ç»Ÿä¾èµ– (Playwrightéœ€è¦)
      - name: ðŸ“¦ Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2

      # 4. å®‰è£… Python ä¾èµ–
      - name: ðŸ“š Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium

      # 5. é…ç½®çŽ¯å¢ƒå˜é‡ (ä»Ž GitHub Secrets)
      - name: âš™ï¸ Configure environment
        run: |
          cat > .env << EOF
          # Xå¹³å°è®¤è¯
          X_AUTH_TOKEN=${{ secrets.X_AUTH_TOKEN }}
          X_CT0_TOKEN=${{ secrets.X_CT0_TOKEN }}
          X_CSRF_TOKEN=${{ secrets.X_CSRF_TOKEN }}
          X_BEARER_TOKEN=${{ secrets.X_BEARER_TOKEN }}

          # LLMé…ç½®
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}

          # ä»£ç†é…ç½® (å¯é€‰)
          HTTP_PROXY=${{ secrets.HTTP_PROXY }}
          HTTPS_PROXY=${{ secrets.HTTPS_PROXY }}

          # çˆ¬è™«é…ç½®
          REQUESTS_PER_HOUR=400
          DAILY_TWEET_COUNT=100
          DATA_DIR=crawler_data
          EOF

      # 6. è¿è¡Œçˆ¬è™«
      - name: ðŸ•·ï¸ Run crawler
        run: |
          TWEET_COUNT="${{ github.event.inputs.tweet_count || '500' }}"
          FORCE_FLAG=""

          if [ "${{ github.event.inputs.force_summary }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi

          python run_crawler.py --count $TWEET_COUNT --user-summaries $FORCE_FLAG
        continue-on-error: true

      # 7. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
      - name: ðŸ“Š Generate report
        if: always()
        run: |
          echo "## ðŸ¤– çˆ¬è™«è¿è¡ŒæŠ¥å‘Š" > report.md
          echo "" >> report.md
          echo "- ðŸ• è¿è¡Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> report.md
          echo "- ðŸŽ¯ ç›®æ ‡æ•°é‡: ${{ github.event.inputs.tweet_count || '500' }} æ¡" >> report.md
          echo "" >> report.md

          # ç»Ÿè®¡ç”Ÿæˆçš„æ–‡ä»¶
          if [ -d "crawler_data/users_daily" ]; then
            USER_COUNT=$(ls -1 crawler_data/users_daily/*.json 2>/dev/null | wc -l)
            echo "- ðŸ‘¥ ç”¨æˆ·æ•°æ®æ–‡ä»¶: $USER_COUNT ä¸ª" >> report.md
          fi

          if [ -d "crawler_data/user_summaries" ]; then
            SUMMARY_COUNT=$(ls -1 crawler_data/user_summaries/*.md 2>/dev/null | wc -l)
            echo "- ðŸ“ æ€»ç»“æ–‡ä»¶: $SUMMARY_COUNT ä¸ª" >> report.md
          fi

          cat report.md

      # 8. æäº¤æ•°æ®åˆ°ä»“åº“
      - name: ðŸ’¾ Commit and push data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ·»åŠ æ•°æ®æ–‡ä»¶
          git add crawler_data/
          git add report.md

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°æ•°æ®éœ€è¦æäº¤"
          else
            git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°: $(date +'%Y-%m-%d') çˆ¬è™«æ•°æ®"
            git push
          fi

      # 9. ä¸Šä¼ è¿è¡ŒæŠ¥å‘Šä¸º Artifact (ä¿ç•™30å¤©)
      - name: ðŸ“¤ Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crawler-report-${{ github.run_number }}
          path: |
            report.md
            crawler_data/daily_posts/*.json
          retention-days: 30

      # 10. å¤±è´¥é€šçŸ¥ (å¤šç§æ–¹æ¡ˆå¯é€‰)

      # æ–¹æ¡ˆ 1: GitHub Issue (è‡ªåŠ¨åˆ›å»º Issueï¼Œæ— éœ€é¢å¤–é…ç½®)
      - name: ðŸ› Create Issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Crawler Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## è¿è¡Œå¤±è´¥æŠ¥å‘Š

              **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
              **å·¥ä½œæµ**: ${context.workflow}

              ðŸ”— [æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId})

              ### å¯èƒ½åŽŸå› 
              - [ ] X è®¤è¯ token è¿‡æœŸ
              - [ ] OpenRouter API é…é¢ä¸è¶³
              - [ ] ç½‘ç»œè¿žæŽ¥é—®é¢˜

              ---
              *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`,
              labels: ['bot', 'crawler-failure']
            });

      # æ–¹æ¡ˆ 2: Telegram é€šçŸ¥ (æŽ¨è)
      - name: ðŸ“± Send Telegram notification
        if: ${{ failure() && secrets.TELEGRAM_BOT_TOKEN != '' }}
        run: |
          MESSAGE="âŒ *X Crawler è¿è¡Œå¤±è´¥*

          ðŸ“… æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          ðŸ”— [æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"${MESSAGE}\",
              \"parse_mode\": \"Markdown\"
            }"

      # æ–¹æ¡ˆ 3: ä¼ä¸šå¾®ä¿¡/é’‰é’‰/Bark (æ ¹æ®éœ€è¦é€‰æ‹©)
      - name: ðŸ“¢ Send WeChat Work notification
        if: ${{ failure() && secrets.WECHAT_WEBHOOK != '' }}
        run: |
          curl -s -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "content": "## ðŸš¨ X Crawler è¿è¡Œå¤±è´¥\n\n>æ—¶é—´: '"$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"'\n\n[æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }
            }'
