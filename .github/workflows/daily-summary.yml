name: Daily Summary Generator

on:
  # å®šæ—¶ä»»åŠ¡ - æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š9ç‚¹è¿è¡Œ (UTC+8 = 01:00 UTC)
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤© UTC 01:00 (åŒ—äº¬æ—¶é—´ 09:00)

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_summary:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ€»ç»“ (true/false)'
        required: false
        default: 'false'

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # å…è®¸æ¨é€ä»£ç 
      issues: write        # å…è®¸åˆ›å»º Issue

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3. å®‰è£… Python ä¾èµ–
      - name: ğŸ“š Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. é…ç½®ç¯å¢ƒå˜é‡
      - name: âš™ï¸ Configure environment
        run: |
          cat > .env << EOF
          # LLMé…ç½® (æ€»ç»“éœ€è¦)
          OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}

          # ä»£ç†é…ç½® (å¯é€‰)
          HTTP_PROXY=${{ secrets.HTTP_PROXY }}
          HTTPS_PROXY=${{ secrets.HTTPS_PROXY }}

          # æ•°æ®ç›®å½•
          DATA_DIR=crawler_data
          EOF

      # 5. ç”Ÿæˆæ˜¨å¤©çš„ç”¨æˆ·æ€»ç»“
      - name: ğŸ¤– Generate user summaries
        run: |
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force_summary }}" = "true" ]; then
            FORCE_FLAG="--force"
            echo "å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ€»ç»“"
          fi

          echo "ä¸ºæ˜¨å¤©çš„æ•°æ®ç”Ÿæˆç”¨æˆ·æ€»ç»“..."
          python run_crawler.py --user-summaries $FORCE_FLAG
        continue-on-error: true

      # 6. ç”Ÿæˆè¿è¡ŒæŠ¥å‘Š
      - name: ğŸ“Š Generate report
        if: always()
        run: |
          echo "## ğŸ¤– æ€»ç»“ç”ŸæˆæŠ¥å‘Š" > report.md
          echo "" >> report.md
          echo "- ğŸ• è¿è¡Œæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> report.md
          echo "- ğŸ“ ä»»åŠ¡ç±»å‹: ç”Ÿæˆæ˜¨å¤©çš„ç”¨æˆ·æ€»ç»“" >> report.md
          echo "" >> report.md

          # ç»Ÿè®¡æ€»ç»“æ–‡ä»¶
          if [ -d "crawler_data/user_summaries" ]; then
            SUMMARY_COUNT=$(ls -1 crawler_data/user_summaries/*.md 2>/dev/null | wc -l)
            echo "- ğŸ“„ æ€»ç»“æ–‡ä»¶æ€»æ•°: $SUMMARY_COUNT ä¸ª" >> report.md

            # ç»Ÿè®¡ä»Šå¤©ç”Ÿæˆçš„æ€»ç»“
            TODAY=$(date +'%Y%m%d')
            TODAY_SUMMARY_COUNT=$(ls -1 crawler_data/user_summaries/*_${TODAY}_*.md 2>/dev/null | wc -l)
            echo "- âœ¨ ä»Šå¤©ç”Ÿæˆ: $TODAY_SUMMARY_COUNT ä¸ª" >> report.md
          fi

          cat report.md

      # 7. æäº¤æ€»ç»“åˆ°ä»“åº“
      - name: ğŸ’¾ Commit and push summaries
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # åªæ·»åŠ æ€»ç»“æ–‡ä»¶
          git add crawler_data/user_summaries/

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°æ€»ç»“éœ€è¦æäº¤"
          else
            git commit -m "ğŸ¤– æ€»ç»“æ›´æ–°: $(date +'%Y-%m-%d') æ¯æ—¥æ€»ç»“"
            git push
          fi

      # 8. ä¸Šä¼ è¿è¡ŒæŠ¥å‘Š
      - name: ğŸ“¤ Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: summary-report-${{ github.run_number }}
          path: |
            report.md
            crawler_data/user_summaries/*.md
          retention-days: 30

      # 9. å¤±è´¥é€šçŸ¥
      - name: ğŸ› Create Issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Daily Summary Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## æ€»ç»“ç”Ÿæˆå¤±è´¥æŠ¥å‘Š

              **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
              **å·¥ä½œæµ**: ${context.workflow}

              ğŸ”— [æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId})

              ### å¯èƒ½åŸå› 
              - [ ] OpenRouter API é…é¢ä¸è¶³
              - [ ] LLM API å¯†é’¥è¿‡æœŸ
              - [ ] æ˜¨å¤©æ²¡æœ‰æ•°æ®æ–‡ä»¶
              - [ ] ç½‘ç»œè¿æ¥é—®é¢˜

              ---
              *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`,
              labels: ['bot', 'summary-failure']
            });

      # 10. Telegram é€šçŸ¥ (å¯é€‰)
      - name: ğŸ“± Send Telegram notification
        if: failure()
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
            MESSAGE="âŒ *X Summary ç”Ÿæˆå¤±è´¥*

            ğŸ“… æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            ğŸ”— [æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
                \"text\": \"${MESSAGE}\",
                \"parse_mode\": \"Markdown\"
              }"
          fi
