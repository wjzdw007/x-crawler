name: Notification Examples

# è¿™ä¸ªæ–‡ä»¶å±•ç¤ºäº†å¤šç§é€šçŸ¥æ–¹å¼ï¼Œå¯ä»¥é›†æˆåˆ° daily-crawler.yml ä¸­

on:
  workflow_dispatch:

jobs:
  # ==========================================
  # æ–¹æ¡ˆ 1: GitHub Issues (æœ€ç®€å•ï¼Œæ— éœ€é¢å¤–é…ç½®)
  # ==========================================
  github-issue-notification:
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: ğŸ› Create GitHub Issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Crawler Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `
              ## è¿è¡Œå¤±è´¥æŠ¥å‘Š

              **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
              **å·¥ä½œæµ**: ${context.workflow}
              **è¿è¡ŒID**: ${context.runId}

              ### è¯¦ç»†ä¿¡æ¯
              - **ä»“åº“**: ${context.repo.owner}/${context.repo.repo}
              - **åˆ†æ”¯**: ${context.ref}
              - **æäº¤**: ${context.sha.substring(0, 7)}
              - **è§¦å‘è€…**: ${context.actor}

              ### å¿«é€Ÿé“¾æ¥
              ğŸ”— [æŸ¥çœ‹è¿è¡Œæ—¥å¿—](${context.payload.repository.html_url}/actions/runs/${context.runId})

              ### å¯èƒ½åŸå› 
              - [ ] X è®¤è¯ token è¿‡æœŸ
              - [ ] OpenRouter API é…é¢ä¸è¶³
              - [ ] ç½‘ç»œè¿æ¥é—®é¢˜
              - [ ] ä»£ç é€»è¾‘é”™è¯¯

              ---
              *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
              `,
              labels: ['bot', 'crawler-failure', 'urgent']
            });
            console.log(`Created issue #${issue.data.number}`);

  # ==========================================
  # æ–¹æ¡ˆ 2: Email é€šçŸ¥ (GitHub å†…ç½®ï¼Œæ— éœ€é…ç½®)
  # ==========================================
  # è¯´æ˜: GitHub é»˜è®¤ä¼šå‘ä½ çš„æ³¨å†Œé‚®ç®±å‘é€å¤±è´¥é€šçŸ¥
  # å¯ä»¥åœ¨ Settings â†’ Notifications â†’ Actions ä¸­é…ç½®


  # ==========================================
  # æ–¹æ¡ˆ 3: Telegram Bot (æ¨è â­)
  # ==========================================
  telegram-notification:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“± Send Telegram notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          EMOJI="âœ…"

          if [ "$STATUS" = "failure" ]; then
            EMOJI="âŒ"
          elif [ "$STATUS" = "cancelled" ]; then
            EMOJI="âš ï¸"
          fi

          MESSAGE="${EMOJI} *X Crawler è¿è¡Œ${STATUS}*

          ğŸ“… æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          ğŸ”— [æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ğŸ“Š ä»“åº“: \`${{ github.repository }}\`
          ğŸŒ¿ åˆ†æ”¯: \`${{ github.ref_name }}\`
          ğŸ‘¤ è§¦å‘: ${{ github.actor }}"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\",
              \"text\": \"${MESSAGE}\",
              \"parse_mode\": \"Markdown\",
              \"disable_web_page_preview\": true
            }"

  # ==========================================
  # æ–¹æ¡ˆ 4: ä¼ä¸šå¾®ä¿¡ç¾¤æœºå™¨äºº
  # ==========================================
  wechat-work-notification:
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: ğŸ“¢ Send WeChat Work notification
        run: |
          curl -s -X POST "${{ secrets.WECHAT_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "content": "## ğŸš¨ X Crawler è¿è¡Œå¤±è´¥\n\n>æ—¶é—´: <font color=\"warning\">'"$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"'</font>\n>ä»“åº“: `${{ github.repository }}`\n>åˆ†æ”¯: `${{ github.ref_name }}`\n\n[ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }
            }'

  # ==========================================
  # æ–¹æ¡ˆ 5: é’‰é’‰ç¾¤æœºå™¨äºº
  # ==========================================
  dingtalk-notification:
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: ğŸ“¢ Send DingTalk notification
        run: |
          curl -s -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "title": "X Crawler è¿è¡Œå¤±è´¥",
                "text": "## ğŸš¨ X Crawler è¿è¡Œå¤±è´¥\n\n- æ—¶é—´: '"$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"'\n- ä»“åº“: ${{ github.repository }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n\n[æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }
            }'

  # ==========================================
  # æ–¹æ¡ˆ 6: Discord Webhook
  # ==========================================
  discord-notification:
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: ğŸ® Send Discord notification
        run: |
          curl -s -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸš¨ X Crawler è¿è¡Œå¤±è´¥",
                "description": "å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥",
                "color": 15158332,
                "fields": [
                  {
                    "name": "ğŸ“… æ—¶é—´",
                    "value": "'"$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"'",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“Š ä»“åº“",
                    "value": "`${{ github.repository }}`",
                    "inline": true
                  },
                  {
                    "name": "ğŸŒ¿ åˆ†æ”¯",
                    "value": "`${{ github.ref_name }}`",
                    "inline": true
                  }
                ],
                "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }'

  # ==========================================
  # æ–¹æ¡ˆ 7: Slack (ä¼ä¸šç”¨æˆ·)
  # ==========================================
  slack-notification:
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: ğŸ’¬ Send Slack notification
        run: |
          curl -s -X POST "${{ secrets.SLACK_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš¨ X Crawler è¿è¡Œå¤±è´¥"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*æ—¶é—´:*\n'"$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"'"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ä»“åº“:*\n`${{ github.repository }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*åˆ†æ”¯:*\n`${{ github.ref_name }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*è§¦å‘è€…:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹è¯¦æƒ…"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }'

  # ==========================================
  # æ–¹æ¡ˆ 8: Bark (iOS æ¨é€ï¼Œæœ€ç®€å•)
  # ==========================================
  bark-notification:
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: ğŸ“± Send Bark notification
        run: |
          curl -s "https://api.day.app/${{ secrets.BARK_KEY }}/X%20Crawler%20å¤±è´¥/$(TZ='Asia/Shanghai' date '+%Y-%m-%d %20%H:%M:%S')?group=crawler&url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
